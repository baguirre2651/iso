<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Search Of - The Social Marketplace</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M8 11.5A4.5 4.5 0 1 1 12.5 7 4.5 4.5 0 0 1 8 11.5z'/%3E%3Cpath d='m21 21-4.3-4.3'/%3E%3Cpath d='m15 12 2 2 4-4'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        h1, h2, h3, h4 {
            font-family: 'DM Serif Display', serif;
        }
        .modal-backdrop {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 40; backdrop-filter: blur(4px);
        }
        .modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 50; max-height: 90vh; overflow-y: auto;
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -48%) scale(0.95); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .main-content, .detail-view, .how-it-works-view, .my-iso-view, .finder-hub-view, .seller-portal-view, .landing-view, .profile-view { display: none; }
        .main-content.active, .detail-view.active, .how-it-works-view.active, .my-iso-view.active, .finder-hub-view.active, .seller-portal-view.active, .landing-view.active, .profile-view.active { display: block; }
        .upvote-btn.upvoted { background-color: #4f46e5; color: white; }
        .comment-bubble, .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #E5E7EB;
            border-bottom-color: #4f46e5;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .upvote-blink {
            animation: upvote-animation 0.5s ease;
        }
        @keyframes upvote-animation {
            50% { 
                background-color: #34d399;
                color: white;
                transform: scale(1.1);
            }
        }
        .chat-message { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator span {
            animation: bob 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bob {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .filter-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .nav-link.active, .nav-link-mobile.active {
            color: #4f46e5;
            font-weight: 600;
        }
        .nav-link-mobile.active {
            border-bottom: 2px solid #4f46e5;
        }
        .notification-enter-animation {
            animation: notification-fade-in 0.4s ease-out forwards;
        }
        @keyframes notification-fade-in {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .celebration-overlay {
            animation: celebration-fade-in 0.5s ease-out forwards;
        }
        @keyframes celebration-fade-in {
            from { opacity: 0; backdrop-filter: blur(0px); }
            to { opacity: 1; backdrop-filter: blur(8px); }
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 28px;
            bottom: -4px;
            width: 2px;
            background-color: #e5e7eb;
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .interest-card.selected {
            border-color: #4f46e5;
            background-color: #eef2ff;
            color: #4338ca;
        }
        .animate-on-scroll {
            opacity: 0;
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .fade-in-up {
            transform: translateY(30px);
        }
        .fade-in {
            transform: scale(0.95);
        }
        .is-visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        .blinking-cursor {
            font-weight: 300; /* A thinner cursor */
            color: #4f46e5; /* Match the accent color */
            animation: blink-caret 0.8s step-end 4; /* Blinks 4 times, then disappears */
        }

        @keyframes blink-caret {
            from, to { opacity: 0; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-6 right-6 z-[100] space-y-2 w-full max-w-xs"></div>

    <!-- Main Application Container -->
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="flex justify-between items-center pb-6 border-b border-gray-200">
            <a href="#" id="logo-link" class="flex items-center space-x-3 text-gray-900 no-underline">
                <div class="bg-indigo-600 text-white w-10 h-10 flex items-center justify-center rounded-lg shadow-md">
                    <i data-lucide="search-check" class="w-6 h-6"></i>
                </div>
                <h1 class="text-2xl md:text-3xl font-bold tracking-tight">In Search Of</h1>
            </a>
             <nav class="hidden md:flex items-center space-x-6 text-sm">
                <a href="#" class="nav-link text-gray-600 hover:text-indigo-600 transition-colors" data-view="main-content">Hunts</a>
                <a href="#" class="nav-link text-gray-600 hover:text-indigo-600 transition-colors" data-view="my-iso-view">My ISO</a>
                <a href="#" class="nav-link text-gray-600 hover:text-indigo-600 transition-colors" data-view="finder-hub-view">Finder Hub</a>
                <a href="#" class="nav-link text-gray-600 hover:text-indigo-600 transition-colors" data-view="seller-portal-view">Seller Portal</a>
                <a href="#" class="nav-link text-gray-600 hover:text-indigo-600 transition-colors" data-view="how-it-works-view">How It Works</a>
            </nav>
            <div class="flex items-center space-x-3">
                <button id="messages-btn" class="text-gray-500 hover:text-indigo-600">
                    <i data-lucide="message-square" class="w-6 h-6"></i>
                </button>
                <button id="post-iso-btn" class="hidden md:flex bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors items-center space-x-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Create ISO</span>
                </button>
                <!-- Profile Dropdown -->
                <div class="relative">
                    <button id="profile-dropdown-btn" class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden focus:outline-none ring-2 ring-offset-2 ring-transparent focus:ring-indigo-500">
                        <img src="https://i.pravatar.cc/150?u=me" alt="Profile" class="w-full h-full object-cover">
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-100 z-50 py-2">
                        <div class="px-4 py-3 border-b border-gray-100 mb-1">
                            <p class="text-sm font-bold text-gray-900">@newSeeker</p>
                            <p class="text-xs text-gray-500">Collector</p>
                        </div>
                        <a href="#" data-view="my-iso-view" class="profile-dropdown-link w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"><i data-lucide="search" class="w-4 h-4"></i> My ISO</a>
                        <a href="#" data-view="finder-hub-view" class="profile-dropdown-link w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"><i data-lucide="scan-eye" class="w-4 h-4"></i> Finder Hub</a>
                        <a href="#" data-view="seller-portal-view" class="profile-dropdown-link w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"><i data-lucide="store" class="w-4 h-4"></i> Seller Portal</a>
                        <div class="h-px bg-gray-100 my-1"></div>
                        <a href="#" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Sign Out</a>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Mobile Nav -->
        <div class="md:hidden mt-4 mb-4">
             <nav class="flex flex-wrap text-sm border-b">
                <a href="#" class="nav-link-mobile w-1/3 text-center py-2 font-semibold text-gray-500" data-view="main-content">Hunts</a>
                <a href="#" class="nav-link-mobile w-1/3 text-center py-2 font-semibold text-gray-500" data-view="my-iso-view">My ISO</a>
                <a href="#" class="nav-link-mobile w-1/3 text-center py-2 font-semibold text-gray-500" data-view="finder-hub-view">Finder Hub</a>
                <a href="#" class="nav-link-mobile w-1/3 text-center py-2 font-semibold text-gray-500" data-view="seller-portal-view">Seller Portal</a>
                <a href="#" class="nav-link-mobile w-1/3 text-center py-2 font-semibold text-gray-500" data-view="how-it-works-view">How It Works</a>
            </nav>
        </div>

        <!-- Landing Page View -->
        <div id="landing-view" class="landing-view">
            <!-- Hero Section -->
            <div class="relative overflow-hidden -mx-4 sm:-mx-6 lg:-mx-8" style="background: radial-gradient(circle at top left, #e0e7ff, transparent 40%), radial-gradient(circle at bottom right, #fef3c7, transparent 30%), #ffffff;">
                <div class="relative max-w-7xl mx-auto px-6 py-24 lg:py-40 flex flex-col items-center text-center">
                    <h1 class="text-5xl md:text-7xl font-extrabold text-gray-900 tracking-tight mb-6 max-w-4xl leading-tight">
                        Post your hunt.<span class="blinking-cursor">|</span> <br><span class="text-indigo-600">Our experts find it.</span>
                    </h1>
                    <p class="text-xl text-gray-600 max-w-2xl mb-10 leading-relaxed">
                        Stop refreshing listing pages. Create an ISO (In Search Of) post, name your price, and let sellers bring the items directly to you.
                    </p>
                    <div class="flex flex-col sm:flex-row items-center justify-center w-full sm:w-auto">
                        <div class="p-2">
                            <button id="landing-post-hunt-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg text-base hover:bg-indigo-700 transition-all shadow-lg hover:shadow-xl shadow-indigo-200">
                                Post a Hunt
                            </button>
                        </div>
                        <div class="p-2">
                            <button id="landing-become-finder-btn" class="px-6 py-3 bg-white text-gray-900 border-2 border-gray-200 font-semibold rounded-lg text-base hover:border-indigo-600 hover:text-indigo-600 transition-all hover:shadow-lg">
                                Browse Hunts
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Why Choose Us Section -->
            <div class="bg-white py-24 -mx-4 sm:-mx-6 lg:-mx-8 animate-on-scroll fade-in-up">
                <div class="max-w-4xl mx-auto px-6">
                    <div class="space-y-12">
                        <div class="flex items-start gap-8 border-b border-gray-100 pb-12">
                            <div class="text-5xl font-bold text-gray-200">01</div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900 mb-2">Broadcast Your Demand</h3>
                                <p class="text-gray-600 leading-relaxed">Instead of searching, you announce. Post what you're looking for once and let our network of sellers and collectors find it for you.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-8 border-b border-gray-100 pb-12">
                            <div class="text-5xl font-bold text-gray-200">02</div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900 mb-2">Discover Hidden Inventory</h3>
                                <p class="text-gray-600 leading-relaxed">Tap into a market of items that aren't publicly listed. Many sellers have the perfect item in their collection, waiting for the right buyer to ask.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-8">
                            <div class="text-5xl font-bold text-gray-200">03</div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900 mb-2">Name Your Price</h3>
                                <p class="text-gray-600 leading-relaxed">You're in control. Post your top offer to attract serious sellers and streamline the negotiation process from the very beginning.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- How It Works Summary -->
            <div class="bg-gray-50 py-24 border-y border-gray-200 -mx-4 sm:-mx-6 lg:-mx-8 animate-on-scroll fade-in-up">
                <div class="max-w-7xl mx-auto px-6">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl font-bold text-gray-900">A Simple, Powerful Flow</h2>
                        <p class="text-gray-500 mt-2">Connecting buyers and sellers has never been more direct.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                        <div class="p-8 rounded-2xl bg-white border border-gray-100 text-center animate-on-scroll fade-in-up shadow-sm" style="transition-delay: 100ms;">
                            <div class="w-14 h-14 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mb-6 mx-auto"><i data-lucide="shopping-bag" class="w-7 h-7"></i></div>
                            <h3 class="text-xl font-bold text-gray-900 mb-4">For Buyers</h3>
                            <ul class="space-y-3 text-gray-600 text-left text-sm">
                                <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mr-2 mt-0.5 flex-shrink-0"></i> Post exactly what you want</li>
                                <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mr-2 mt-0.5 flex-shrink-0"></i> Name your top offer price</li>
                                <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mr-2 mt-0.5 flex-shrink-0"></i> Receive offers from sellers</li>
                            </ul>
                        </div>
                        <div class="p-8 rounded-2xl bg-white border border-gray-100 text-center animate-on-scroll fade-in-up shadow-sm" style="transition-delay: 200ms;">
                            <div class="w-14 h-14 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mb-6 mx-auto"><i data-lucide="scan-eye" class="w-7 h-7"></i></div>
                            <h3 class="text-xl font-bold text-gray-900 mb-4">For Finders</h3>
                            <ul class="space-y-3 text-gray-600 text-left text-sm">
                                <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 text-purple-600 mr-2 mt-0.5 flex-shrink-0"></i> Apply to be a vetted expert</li>
                                <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 text-purple-600 mr-2 mt-0.5 flex-shrink-0"></i> Claim active hunts in your niche</li>
                                <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 text-purple-600 mr-2 mt-0.5 flex-shrink-0"></i> Earn commission on success</li>
                            </ul>
                        </div>
                        <div class="p-8 rounded-2xl bg-white border border-gray-100 text-center animate-on-scroll fade-in-up shadow-sm" style="transition-delay: 300ms;">
                            <div class="w-14 h-14 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mb-6 mx-auto"><i data-lucide="store" class="w-7 h-7"></i></div>
                            <h3 class="text-xl font-bold text-gray-900 mb-4">For Sellers</h3>
                            <ul class="space-y-3 text-gray-600 text-left text-sm">
                                <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 text-amber-600 mr-2 mt-0.5 flex-shrink-0"></i> Browse active hunts from buyers</li>
                                <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 text-amber-600 mr-2 mt-0.5 flex-shrink-0"></i> Find a match for your inventory</li>
                                <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 text-amber-600 mr-2 mt-0.5 flex-shrink-0"></i> Make a direct offer to the buyer</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category Showcase -->
            <div class="max-w-7xl mx-auto px-6 py-20 animate-on-scroll fade-in">
                <div class="flex justify-between items-end mb-10">
                    <div><h2 class="text-3xl font-bold text-gray-900 mb-2">Explore Categories</h2><p class="text-gray-500">Browse active hunts by what collectors are looking for.</p></div>
                    <button id="landing-view-all-btn" class="text-indigo-600 font-semibold hover:text-indigo-800 flex items-center">View All <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i></button>
                </div>
                <div id="landing-categories" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Category cards will be injected by JS -->
                </div>
            </div>
        </div>

        <!-- Main Content View (Feed) -->
        <div id="main-content" class="main-content">
            <div class="py-8">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-tight">Hunts</h1>
                <p class="mt-2 text-lg text-gray-500">Browse what collectors are searching for.</p>

                <!-- Control Bar -->
                <div class="mt-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <!-- Search Bar -->
                    <div class="relative flex-grow md:flex-grow-0 md:w-80">
                        <input type="search" id="search-bar" placeholder="Search for items, brands, or users..." class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                        </div>
                    </div>
                    <!-- Filters -->
                    <div id="filter-bar" class="flex space-x-2 overflow-x-auto pb-2 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8">
                        <button class="filter-btn active flex-shrink-0 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full shadow-sm transition-colors" data-category="All">All</button>
                        <button class="filter-btn flex-shrink-0 bg-white text-gray-700 font-semibold py-2 px-4 rounded-full shadow-sm border border-gray-300 hover:bg-gray-100 transition-colors" data-category="Sneakers">Sneakers</button>
                        <button class="filter-btn flex-shrink-0 bg-white text-gray-700 font-semibold py-2 px-4 rounded-full shadow-sm border border-gray-300 hover:bg-gray-100 transition-colors" data-category="Archival Fashion">Archival Fashion</button>
                        <button class="filter-btn flex-shrink-0 bg-white text-gray-700 font-semibold py-2 px-4 rounded-full shadow-sm border border-gray-300 hover:bg-gray-100 transition-colors" data-category="Collectibles">Collectibles</button>
                        <button class="filter-btn flex-shrink-0 bg-white text-gray-700 font-semibold py-2 px-4 rounded-full shadow-sm border border-gray-300 hover:bg-gray-100 transition-colors" data-category="Watches">Watches</button>
                    </div>
                </div>
            </div>
    
            <!-- ISO Feed Grid -->
            <div id="iso-feed" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- ISO cards will be injected here -->
            </div>
        </div>

        <!-- My ISO View (Buyer Dashboard) -->
        <div id="my-iso-view" class="my-iso-view">
            <div class="py-6">
                <h2 class="text-2xl font-bold text-gray-900">My ISO Hub</h2>
                <p class="text-gray-500 mt-1">Manage your active hunts, review offers, and view your collection.</p>
            </div>

            <!-- Action Required Section -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Action Required</h3>
                <div id="my-iso-action-required">
                    <!-- Actionable items will be injected here -->
                </div>
            </div>

            <!-- Active Hunts Section -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">My Active Hunts</h3>
                <div id="my-iso-active-hunts" class="space-y-4">
                     <!-- Active hunts will be injected here -->
                </div>
            </div>

             <!-- My Collection Section -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-3">My Collection</h3>
                <div id="my-iso-collection" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Collection items will be injected here -->
                </div>
            </div>
        </div>

        <!-- Finder Hub View -->
        <div id="finder-hub-view" class="finder-hub-view">
            <div class="py-6">
                <h2 class="text-2xl font-bold text-gray-900">Finder Hub</h2>
                <p class="text-gray-500 mt-1">Manage your claimed hunts, source new leads, and track your performance.</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <!-- Hunt Pool -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">The Hunt Pool (New Leads)</h3>
                        <div id="finder-hunt-pool" class="space-y-4">
                             <!-- Hunt pool will be injected here -->
                        </div>
                    </div>
                     <!-- My Active Hunts -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">My Active Hunts</h3>
                        <div id="finder-active-hunts" class="space-y-4">
                             <!-- Finder's active hunts will be injected here -->
                        </div>
                    </div>
                </div>
                <!-- Finder Stats -->
                <aside>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 space-y-6">
                        <div>
                            <h3 class="font-bold text-lg mb-4 text-gray-900">Your Stats</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Active Hunts</span>
                                    <span class="font-bold text-indigo-600">1</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Success Rate</span>
                                    <span class="font-bold">92%</span>
                                </div>
                                 <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Your Rating</span>
                                    <span class="font-bold flex items-center">5.0 <i data-lucide="star" class="w-4 h-4 fill-yellow-400 text-yellow-400 ml-1"></i></span>
                                </div>
                                <div class="pt-4 border-t">
                                    <p class="text-sm text-gray-600">Earnings (30 Days)</p>
                                    <p class="text-2xl font-bold text-green-600">$1,850</p>
                                </div>
                            </div>
                        </div>
                         <!-- Onboarding CTA -->
                        <div class="pt-6 border-t">
                            <h3 class="font-bold text-lg mb-2">Become a Vetted Finder</h3>
                            <p class="text-sm text-gray-600 mb-4">Monetize your expertise and get access to a stream of qualified buyers.</p>
                            <button class="w-full bg-indigo-100 text-indigo-700 font-semibold py-2 rounded-lg hover:bg-indigo-200 transition-colors">Apply Now</button>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
        
        <!-- Seller Portal View -->
        <div id="seller-portal-view" class="seller-portal-view">
            <div class="py-6">
                <h2 class="text-2xl font-bold text-gray-900">Seller Portal</h2>
                <p class="text-gray-500 mt-1">Respond to qualified leads from our expert Finders.</p>
            </div>
            <div class="space-y-8">
                 <!-- Requests from Finders -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Requests from Finders</h3>
                     <div id="seller-requests">
                         <!-- Seller requests will be injected here -->
                     </div>
                </div>
                 <!-- My Sent Offers -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">My Sent Offers</h3>
                     <div id="seller-offers">
                        <!-- Seller offers will be injected here -->
                     </div>
                </div>
            </div>
        </div>

        <!-- Detail View -->
        <div id="detail-view" class="detail-view">
            <!-- Detail content will be injected here -->
        </div>

        <!-- How It Works View -->
        <div id="how-it-works-view" class="how-it-works-view">
             <div class="py-12 text-center">
                <h2 class="text-3xl font-bold text-gray-900">The Triangulation Marketplace: A Marketplace Built on Demand</h2>
                <p class="text-lg text-gray-500 mt-2 max-w-3xl mx-auto">We flip the traditional e-commerce model. Instead of sellers listing items, our community of seekers posts exactly what they’re looking for first.</p>
            </div>
            
            <div class="my-12 bg-white p-8 rounded-xl shadow-sm border border-gray-200 max-w-4xl mx-auto">
                <h3 class="text-2xl font-bold text-center text-indigo-600 mb-4">Community vs. Commodity</h3>
                <p class="text-center text-gray-600 leading-relaxed">
                    Traditional marketplaces are built for sellers to list inventory. <strong class="text-indigo-600">We are a platform built for communities to express demand.</strong> We believe that for the most passionate collectors, the joy of discovery is just as important as the purchase. Our entire model is designed to make the hunt more efficient, trustworthy, and ultimately, more rewarding by connecting you with a dedicated expert who manages the search for you.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-8 items-start my-12 max-w-6xl mx-auto">
                <!-- Step 1 -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center flex flex-col h-full">
                    <div class="mx-auto bg-indigo-100 text-indigo-600 w-12 h-12 flex items-center justify-center rounded-full mb-4 flex-shrink-0">
                        <i data-lucide="message-circle" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">1. Post Your ISO</h3>
                    <p class="text-sm text-gray-600 mt-auto">A buyer starts a hunt by telling our Chat Assistant exactly what they're looking for, adding a reference photo, and verifying their funds.</p>
                </div>
                <!-- Step 2 -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center flex flex-col h-full">
                    <div class="mx-auto bg-indigo-100 text-indigo-600 w-12 h-12 flex items-center justify-center rounded-full mb-4 flex-shrink-0">
                        <i data-lucide="user-check" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">2. Match with a Finder</h3>
                    <p class="text-sm text-gray-600 mt-auto">We match the hunt with a vetted expert (a "Finder") in that category who acts as the buyer's trusted, personal Hunt Manager.</p>
                </div>
                <!-- Step 3 -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center flex flex-col h-full">
                    <div class="mx-auto bg-indigo-100 text-indigo-600 w-12 h-12 flex items-center justify-center rounded-full mb-4 flex-shrink-0">
                        <i data-lucide="search" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">3. Finder Sources Items</h3>
                    <p class="text-sm text-gray-600 mt-auto">The Finder uses our Syndication Engine and their private network to source options from trusted sellers across the market.</p>
                </div>
                <!-- Step 4 -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center flex flex-col h-full">
                    <div class="mx-auto bg-indigo-100 text-indigo-600 w-12 h-12 flex items-center justify-center rounded-full mb-4 flex-shrink-0">
                        <i data-lucide="shield-check" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">4. Verify & Present</h3>
                    <p class="text-sm text-gray-600 mt-auto">The Finder verifies the items, provides expert context, and presents a curated list of the best options back to the buyer.</p>
                </div>
                 <!-- Step 5 -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center flex flex-col h-full">
                    <div class="mx-auto bg-indigo-100 text-indigo-600 w-12 h-12 flex items-center justify-center rounded-full mb-4 flex-shrink-0">
                        <i data-lucide="handshake" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">5. Secure the Deal</h3>
                    <p class="text-sm text-gray-600 mt-auto">The buyer accepts the best offer. We handle the secure escrow payment and insured shipping to complete the deal.</p>
                </div>
            </div>

            <div class="mt-16">
                 <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-900">A Marketplace Built on Trust</h2>
                    <p class="text-lg text-gray-500 mt-2 max-w-3xl mx-auto">By adding a layer of vetted human expertise, we eliminate the risks and friction of high-value online transactions.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-start space-x-4">
                        <div class="bg-green-100 text-green-600 w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-full">
                            <i data-lucide="shield-check" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2">For Buyers</h3>
                            <p class="text-sm text-gray-600">Get exactly what you want without the endless search. Every item is verified by a trusted expert, and every transaction is protected by secure escrow.</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-start space-x-4">
                        <div class="bg-purple-100 text-purple-600 w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-full">
                            <i data-lucide="tag" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2">For Sellers & Finders</h3>
                            <p class="text-sm text-gray-600">Stop waiting for buyers. Get direct access to a stream of verified, high-intent demand and monetize your inventory or your expertise with zero risk.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="modal-backdrop"></div>
    
    <!-- New ISO Creation Modal -->
    <div id="iso-modal" class="modal bg-white rounded-xl shadow-2xl w-full max-w-lg">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
             <div class="flex items-center space-x-2">
                <h3 class="text-xl font-bold">Create a New ISO</h3>
             </div>
             <button id="close-iso-modal" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <!-- Tabs -->
        <div class="border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-chat" class="px-3 py-2 font-medium text-sm rounded-t-md text-indigo-600 border-b-2 border-indigo-500">
                    Chat Assistant
                </button>
                <button id="tab-form" class="px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-gray-700">
                    Manual Form
                </button>
            </nav>
        </div>

        <!-- Chat View -->
        <div id="chat-view">
            <div id="chat-log" class="p-6 h-96 overflow-y-auto space-y-4">
                <!-- Chat messages will be injected here -->
            </div>
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center space-x-2">
                    <input type="text" id="chat-input" placeholder="Type your answer..." class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500" disabled>
                    <button id="chat-submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors" disabled>Send</button>
                </div>
            </div>
        </div>

        <!-- Form View -->
        <div id="form-view" class="hidden">
            <form id="iso-form" class="p-6 space-y-4">
                <div><label for="item-name" class="block text-sm font-medium text-gray-700">Item Name</label><input type="text" id="item-name" placeholder="e.g., Jordan 1 Retro High 'Chicago'" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="item-category" class="block text-sm font-medium text-gray-700">Category</label><select id="item-category" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"><option>Sneakers</option><option>Archival Fashion</option><option>Collectibles</option><option>Watches</option></select></div>
                <div><label for="item-details" class="block text-sm font-medium text-gray-700">Details (Size, Condition)</label><input type="text" id="item-details" placeholder="e.g., Size 10, New/Unworn" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="item-bid" class="block text-sm font-medium text-gray-700">Your Top Offer ($)</label><input type="number" id="item-bid" placeholder="400" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div>
                     <label for="item-duration-form" class="block text-sm font-medium text-gray-700">Hunt Duration</label>
                     <select id="item-duration-form" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                         <option value="7">7 Days</option>
                         <option value="14">14 Days</option>
                         <option value="30" selected>30 Days</option>
                     </select>
                </div>
                <div>
                    <label for="item-image-upload" class="block text-sm font-medium text-gray-700">Reference Image</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <img id="image-preview" src="" class="hidden mx-auto h-24 w-auto mb-4 rounded-md"/>
                            <svg id="image-upload-icon" class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="item-image-upload-input" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                    <span>Upload a file</span>
                                    <input id="item-image-upload-input" name="file-upload" type="file" class="sr-only" accept="image/*">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                        </div>
                    </div>
                </div>
                <div class="pt-2 flex justify-end"><button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Submit Request</button></div>
            </form>
        </div>
    </div>
    
    <!-- Sell / Make Offer Modal -->
    <div id="sell-modal" class="modal bg-white rounded-xl shadow-2xl w-full max-w-lg">
        <!-- Sell modal content will be injected here -->
    </div>

    <!-- Edit ISO Modal -->
     <div id="edit-modal" class="modal bg-white rounded-xl shadow-2xl w-full max-w-lg">
        <!-- Edit modal content will be injected here -->
    </div>

    <!-- View Bids Modal -->
    <div id="bids-modal" class="modal bg-white rounded-xl shadow-2xl w-full max-w-2xl">
        <!-- Bids modal content will be injected here -->
    </div>
    
    <!-- AI Insights Modal -->
    <div id="ai-modal" class="modal bg-white rounded-xl shadow-2xl w-full max-w-lg">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-xl font-bold flex items-center gap-2">✨ AI Market Insights</h3>
            <button id="close-ai-modal" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div id="ai-modal-content" class="p-6">
            <!-- AI content will be injected here -->
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal bg-white rounded-xl shadow-2xl w-full max-w-lg">
         <!-- Profile content will be injected here -->
    </div>

    <!-- Buyback Modal -->
    <div id="buyback-modal" class="modal bg-white rounded-xl shadow-2xl w-full max-w-lg">
         <!-- Buyback content will be injected here -->
    </div>

    <!-- Messages Modal -->
    <div id="messages-modal" class="modal bg-white rounded-xl shadow-2xl w-full max-w-lg">
         <!-- Messages content will be injected here -->
    </div>

    <!-- Purchase Confirmation Modals -->
    <div id="celebration-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 celebration-overlay">
        <!-- Celebration content -->
    </div>
     <div id="next-steps-modal" class="modal bg-white rounded-xl shadow-2xl w-full max-w-lg">
        <!-- Next steps content -->
    </div>

    <script>
        // Use a self-executing function to ensure lucide is available before it's called
        (function() {
            function onDocumentReady(fn) {
                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    setTimeout(fn, 1);
                } else {
                    document.addEventListener('DOMContentLoaded', fn);
                }
            }

            onDocumentReady(function() {
                // Now we are sure the DOM is ready and scripts are loaded.
                if (typeof lucide !== 'undefined') {
                    initializeApp();
                } else {
                    // Fallback in case the script fails to load, though it's unlikely with a CDN.
                    console.error('Lucide library not found.');
                }
            });
        
        // =================================================================================
        // FAKE DATA STORE
        // =================================================================================
        
        let isoData = [
          {
            id: 1,
            seekers: 1,
            joined: false,
            name: "Jordan 1 Retro High 'Chicago'",
            category: "Sneakers",
            details: "Size 10, New/Unworn",
            upvotes: 112,
            topOffer: 550,
            comments: 12,
            imageUrl: "images/jordan1.png",
            user: { name: "@sneakerhead23", avatar: "https://i.pravatar.cc/40?u=user3", rating: 4.9 },
            fundsVerified: true,
            privateBids: 0,
            duration: 30,
            createdAt: Date.now() - (2 * 24 * 60 * 60 * 1000), // Created 2 days ago
            finder: null
          },
          {
            id: 6,
            seekers: 1,
            joined: true, // Let's pretend the user created this one.
            name: "Raf Simons 'Riot' Bomber Jacket",
            category: "Archival Fashion",
            details: "AW 2001, Size 50, Good condition",
            upvotes: 88,
            topOffer: 4500,
            comments: 19,
            imageUrl: "images/raf.png",
            user: { name: "@archive_fiend", avatar: "https://i.pravatar.cc/40?u=user7", rating: 5.0 },
            fundsVerified: true,
            privateBids: 1,
            duration: 14,
            createdAt: Date.now() - (1 * 24 * 60 * 60 * 1000),
            finder: { name: '@TheCurator', specialty: 'Archival Fashion Expert', avatar: 'https://i.pravatar.cc/40?u=curator', rating: 5.0 }
          },
          {
            id: 3,
            seekers: 1,
            joined: false,
            name: "Margaret Keane: 'Big Eyes' Painting",
            category: "Collectibles",
            details: "1960, 'The Crying Girl'",
            upvotes: 45,
            topOffer: 850,
            comments: 5,
            imageUrl: "images/margret.jpg",
            user: { name: "@artcollectorjane", avatar: "https://i.pravatar.cc/40?u=user5", rating: 5.0 },
            fundsVerified: false,
            privateBids: 0,
            duration: 14,
            createdAt: Date.now() - (4 * 24 * 60 * 60 * 1000),
            finder: null
          },
          {
            id: 4,
            seekers: 1,
            joined: false,
            name: "Travis Scott Jordan 1 Low",
            category: "Sneakers",
            details: "Size 9.5, Olive",
            upvotes: 203,
            topOffer: 720,
            comments: 25,
            imageUrl: "images/travis.png",
            user: { name: "@grailHunter", avatar: "https://i.pravatar.cc/40?u=user1", rating: 4.8 },
            fundsVerified: true,
            privateBids: 3,
            duration: 7,
            createdAt: Date.now() - (6 * 24 * 60 * 60 * 1000),
            finder: null
          },
          {
            id: 5,
            seekers: 1,
            joined: false,
            name: "Rolex Daytona 'Panda'",
            category: "Watches",
            details: "116500LN, White Dial",
            upvotes: 18,
            topOffer: 28500,
            comments: 32,
            imageUrl: "images/rolexdaytona.png",
            user: { name: "@watchguy", avatar: "https://i.pravatar.cc/40?u=user6", rating: 5.0 },
            fundsVerified: false,
            privateBids: 0,
            duration: 30,
            createdAt: Date.now() - (10 * 24 * 60 * 60 * 1000),
            finder: null
          }
        ];

        const aiInsightsData = {
            "Jordan 1 Retro High 'Chicago'": "The Air Jordan 1 'Chicago' is arguably the most iconic sneaker ever created. Originally released in 1985, its 'Chicago' colorway is a cornerstone of sneaker culture, synonymous with Michael Jordan's rookie season. The 2022 'Reimagined' version added a vintage, aged look that was met with massive commercial success. For collectors, condition and originality are key; a true 1985 pair is a museum piece, while the Reimagined version offers a more accessible entry into its legacy. The market for this shoe is consistently strong, making it a true blue-chip collectible.",
            "Raf Simons 'Riot' Bomber Jacket": "The Autumn/Winter 2001 'Riot, Riot, Riot' bomber from Raf Simons is a seminal piece of modern menswear. Its oversized silhouette, a collage of patches (including iconic Richey Edwards and Manic Street Preachers references), and military surplus aesthetic defined a generation of fashion. It is considered a holy grail item for fashion archivists. Due to its age and rarity, finding one in good condition is exceptionally difficult. Its value is not just in its material, but its immense cultural significance and influence on subsequent designers. A true museum-quality piece.",
            "Margaret Keane: 'Big Eyes' Painting": "Margaret Keane's Big Eyes paintings are defined by their signature, disproportionately large, doe-like eyes that dominate the canvas. The artworks typically feature women, children, and animals in styles ranging from melancholy and dark to joyful and bright, reflecting different periods of the artist's life.",
            "Travis Scott Jordan 1 Low": "Travis Scott's collaborations with Nike are among the most influential of the modern era. His take on the Air Jordan 1, characterized by the reversed Swoosh, is his signature design element. These releases create a frenzy in the market due to Scott's cultural influence and the limited production numbers. The 'Olive' and 'Fragment' colorways are particularly coveted. Owning a pair signifies being in-the-know with current sneaker culture. The resale market is highly volatile but consistently high, reflecting its status as a modern classic.",
            "Rolex Daytona 'Panda'": "The Rolex Daytona Ref. 116500LN with a white dial, nicknamed the 'Panda,' is one of the most sought-after luxury watches in the world. Its scarcity is manufactured; authorized dealers have notoriously long waitlists, often spanning years. This drives a hyper-inflated secondary market where the watch trades for more than double its retail price. The watch's appeal comes from its perfect proportions, ceramic bezel, racing heritage, and the status associated with the Rolex brand. It's considered a benchmark 'investment' watch by many collectors due to its strong and consistent value retention."
        };
        
        const privateBidsData = {
            4: [ // Travis Scott Jordan 1 Low
                { user: '@resell_king', avatar: 'https://i.pravatar.cc/40?u=resell', price: 710, condition: 'Deadstock with original box. Can ship today.', rating: 4.9, findersNote: null },
                { user: '@sneakerVault', avatar: 'https://i.pravatar.cc/40?u=vault', price: 680, condition: 'VNDS, worn once indoors. Includes extra laces.', rating: 5.0, findersNote: null, hasBuyback: true },
                { user: '@kickzCircle', avatar: 'https://i.pravatar.cc/40?u=kickz', price: 725, condition: 'Perfect condition, OG all. Includes receipt.', rating: 4.7, findersNote: null },
            ],
            6: [ // Raf Simons 'Riot' Bomber Jacket
                { user: '@archive_dealer', avatar: 'https://i.pravatar.cc/40?u=archive', price: 4400, condition: 'Excellent condition for its age, minor fading. From my personal collection.', rating: 5.0, findersNote: "Sourced from a trusted private collector in Japan. I've personally verified the condition and authenticity. This is a clean example of a notoriously fragile piece." }
            ]
        };
        
        // =================================================================================
        // DOM ELEMENT SELECTORS
        // =================================================================================
        const app = document.getElementById('app');
        const isoFeed = document.getElementById('iso-feed');
        const mainContent = document.getElementById('main-content');
        const detailView = document.getElementById('detail-view');
        const howItWorksView = document.getElementById('how-it-works-view');
        const myIsoView = document.getElementById('my-iso-view');
        const finderHubView = document.getElementById('finder-hub-view');
        const sellerPortalView = document.getElementById('seller-portal-view');
        const filterBar = document.getElementById('filter-bar');

        // Modal elements
        const postIsoBtn = document.getElementById('post-iso-btn');
        const isoModal = document.getElementById('iso-modal');
        const sellModal = document.getElementById('sell-modal');
        const editModal = document.getElementById('edit-modal');
        const bidsModal = document.getElementById('bids-modal');
        const aiModal = document.getElementById('ai-modal');
        const aiModalContent = document.getElementById('ai-modal-content');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const closeIsoModalBtn = document.getElementById('close-iso-modal');
        const profileModal = document.getElementById('profile-modal');
        const buybackModal = document.getElementById('buyback-modal');
        const messagesBtn = document.getElementById('messages-btn');
        const messagesModal = document.getElementById('messages-modal');
        const celebrationOverlay = document.getElementById('celebration-overlay');
        const nextStepsModal = document.getElementById('next-steps-modal');
        
        // New ISO Modal elements
        const tabChat = document.getElementById('tab-chat');
        const tabForm = document.getElementById('tab-form');
        const chatView = document.getElementById('chat-view');
        const formView = document.getElementById('form-view');
        const chatLog = document.getElementById('chat-log');
        const chatInput = document.getElementById('chat-input');
        const chatSubmit = document.getElementById('chat-submit');

        // Form elements
        const isoForm = document.getElementById('iso-form');
        const imageUploadInput = document.getElementById('item-image-upload-input');
        const imagePreview = document.getElementById('image-preview');
        const imageUploadIcon = document.getElementById('image-upload-icon');
        const searchBar = document.getElementById('search-bar');

        // Profile Dropdown
        const profileDropdownBtn = document.getElementById('profile-dropdown-btn');
        const profileDropdown = document.getElementById('profile-dropdown');

        // =================================================================================
        // HELPER FUNCTIONS
        // =================================================================================

        function getDaysRemaining(createdAt, duration) {
            const now = Date.now();
            const expirationDate = createdAt + (duration * 24 * 60 * 60 * 1000);
            const remainingTime = expirationDate - now;
            
            if (remainingTime <= 0) {
                return '<span class="text-red-500 font-semibold">Expired</span>';
            }
            
            const remainingDays = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));
            return `<span class="text-gray-500">Expires in ${remainingDays} day${remainingDays > 1 ? 's' : ''}</span>`;
        }

        /**
         * A simulated Gemini API call function.
         */
        async function callGeminiAPI(userQuery, systemPrompt = "") {
            console.log("Simulating Gemini API call with query:", userQuery);
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // For the prototype, we return a mock response based on the query.
            if (userQuery.includes("Generate a compelling description")) {
                return "Seeking this iconic piece for a personal collection. Highly interested in items with good condition and provenance. Looking for a serious seller for a straightforward, secure transaction.";
            }
            if (userQuery.includes("difference between the 1985 and 2022 versions")) {
                return "The original 1985 Air Jordan 1 'Chicago' features a different shape, higher-quality leather, and the original Nike Air branding. The 2022 'Reimagined' version is a tribute that uses artificially aged materials, a different box, and a shape closer to the '85 model than other retros, but it is distinctly a modern interpretation, not a 1-to-1 copy.";
            }
            if (aiInsightsData[userQuery]) {
                return aiInsightsData[userQuery];
            }

            return "I can provide insights on specific collectibles, their history, and market standing. What would you like to know?";
        }

        // =================================================================================
        // CORE RENDER FUNCTIONS
        // =================================================================================

        /**
         * Creates and returns a DOM element for a single Hunt Card.
         * This centralizes the card creation logic.
         * @param {object} item - The ISO data object for the card.
         * @returns {HTMLElement} The card element.
         */
        function createHuntCardElement(item) {
            const card = document.createElement('div'); // bg-white dark:bg-gray-800
            card.className = 'group view-details-btn flex flex-col bg-white dark:bg-gray-800 rounded-2xl p-3 transition-all hover:shadow-xl cursor-pointer border border-transparent dark:hover:border-indigo-500/30 hover:border-indigo-500/20';
            card.dataset.id = item.id;

            const fundsVerifiedBadge = item.fundsVerified 
                ? `<div class="absolute top-3 right-3 flex items-center gap-1.5 rounded-full bg-white/90 dark:bg-gray-900/70 backdrop-blur-sm px-2 py-1 text-xs font-bold text-green-700 dark:text-green-400">
                       <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                       <span>Verified</span>
                   </div>`
                : '';
            
            const seekersHtml = item.seekers > 1 ? `<span class="text-xs font-bold text-gray-500">+${item.seekers - 1} seeker${item.seekers > 2 ? 's' : ''}</span>` : '';

            card.innerHTML = `
                <div class="relative aspect-square w-full overflow-hidden rounded-xl mb-4">
                    <img src="${item.imageUrl}" alt="${item.name}" class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105" />
                    ${fundsVerifiedBadge}
                </div>
                <div class="flex flex-col flex-grow">
                    <h3 class="font-bold text-gray-900 truncate group-hover:text-indigo-600 transition-colors">${item.name}</h3>
                    <p class="text-sm text-gray-500 truncate">${item.details}</p>
                    <div class="mt-3 flex items-end justify-between">
                        <div>
                            <p class="text-[10px] font-bold uppercase tracking-wider text-gray-400">Top Offer</p>
                            <p class="text-xl font-bold text-gray-900">$${item.topOffer.toLocaleString()}</p>
                        </div>
                        ${seekersHtml}
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100 flex items-center space-x-4 text-gray-400">
                        <span class="flex items-center text-sm font-bold"><i data-lucide="arrow-up-circle" class="w-4 h-4 mr-1.5"></i> ${item.upvotes}</span>
                        <span class="flex items-center text-sm font-bold"><i data-lucide="message-square" class="w-4 h-4 mr-1.5"></i> ${item.comments}</span>
                    </div>
                </div>
            `;
            return card;
        }

        /**
         * Renders the main feed of "In Search Of" cards.
         */
        function renderFeed(filterCategory = 'All', searchTerm = '') {
            let filteredData = isoData;

            if (filterCategory !== 'All') {
                filteredData = filteredData.filter(item => item.category === filterCategory);
            }

            if (searchTerm) {
                const lowercasedTerm = searchTerm.toLowerCase();
                filteredData = filteredData.filter(item => 
                    item.name.toLowerCase().includes(lowercasedTerm) ||
                    item.user.name.toLowerCase().includes(lowercasedTerm)
                );
            }

            isoFeed.innerHTML = '';

            filteredData.sort((a, b) => b.createdAt - a.createdAt).forEach(item => {
                const card = createHuntCardElement(item);
                isoFeed.appendChild(card);
            });
            lucide.createIcons();
        }

        /**
         * Renders the detailed view for a single item.
         * @param {string | number} itemId - The ID of the item to display.
         */
        function renderDetailView(itemId) {
            const item = isoData.find(i => i.id === parseInt(itemId));
            if (!item) return;

            document.querySelectorAll('.main-content, .my-iso-view, .finder-hub-view, .seller-portal-view, .how-it-works-view, .landing-view').forEach(v => v.classList.remove('active'));
            
            const ratingHtml = item.user.rating ? `<span class="text-sm text-gray-500 flex items-center"><i data-lucide="star" class="w-4 h-4 fill-yellow-400 text-yellow-400 mr-1"></i> ${item.user.rating} | 5 Successful Hunts</span>` : '';


            const fundsVerifiedBadge = item.fundsVerified 
                ? `<span class="bg-green-100 text-green-800 text-xs font-bold px-2.5 py-1 rounded-full flex items-center space-x-1"><i data-lucide="check-circle" class="w-3 h-3"></i><span>Funds Verified</span></span>` 
                : `<span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-1 rounded-full">Funds Unverified</span>`;
            
            const finderModuleHtml = `
                <div id="finder-module" class="mt-8 transition-opacity duration-500 opacity-0">
                    <!-- Content will be injected by simulation -->
                </div>
            `;
            
            let actionButtons;
            if (item.privateBids > 0) {
                 actionButtons = `<button data-item-id="${item.id}" id="view-bids-btn" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2"><i data-lucide="gavel" class="w-5 h-5"></i><span>Review ${item.privateBids > 1 ? `${item.privateBids} Options` : '1 Option'} from Finder</span></button>`;
            } else {
                 actionButtons = `<button data-item-id="${item.id}" class="sell-item-btn w-full bg-gray-900 text-white font-semibold py-3 rounded-lg hover:bg-gray-800 transition-colors flex items-center justify-center space-x-2"><i data-lucide="tag" class="w-5 h-5"></i><span>I Have This - Sell to Finder</span></button>`;
            }

            const joinButtonText = item.joined ? `<i data-lucide="check" class="w-5 h-5"></i><span>Joined!</span>` : `<i data-lucide="users" class="w-5 h-5"></i><span>Join this Hunt</span>`;
            const joinButtonClasses = item.joined ? 'bg-indigo-200 text-indigo-800' : 'bg-indigo-100 text-indigo-700';
            const daysRemainingHtml = getDaysRemaining(item.createdAt, item.duration);

            detailView.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <button id="back-to-feed" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900 font-semibold"><i data-lucide="arrow-left" class="w-5 h-5"></i><span>Back</span></button>
                    <div class="flex items-center space-x-4">
                        <button id="edit-iso-btn" data-id="${item.id}" class="flex items-center space-x-2 text-sm text-gray-600 hover:text-gray-900 font-semibold"><i data-lucide="edit" class="w-4 h-4"></i><span>Edit Hunt</span></button>
                        <button id="delete-iso-btn" data-id="${item.id}" class="flex items-center space-x-2 text-sm text-red-500 hover:text-red-700 font-semibold"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete ISO (Demo)</span></button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12">
                    <div class="bg-white rounded-lg p-4 flex items-center justify-center shadow-lg lg:col-span-2"><img src="${item.imageUrl}" alt="${item.name}" class="max-h-96 object-contain rounded-md"></div>
                    <div class="lg:col-span-3">
                        <div class="flex items-center space-x-3 mb-3">
                            <img src="${item.user.avatar}" class="w-12 h-12 rounded-full"/>
                            <div>
                                <button class="font-semibold text-gray-800 hover:underline user-profile-link" data-username="${item.user.name}">${item.user.name}</button>
                                ${ratingHtml}
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold tracking-tight text-gray-900 mt-1">${item.name}</h2>
                        <p class="text-lg text-gray-600 mt-2">${item.details}</p>
                        
                        <div class="mt-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm text-gray-500">Top Offer</p>
                                    <p class="text-3xl font-bold text-gray-900">$${item.topOffer.toLocaleString()}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">Community Interest</p>
                                    <p class="text-3xl font-bold text-indigo-600 flex items-center gap-2"><i data-lucide="arrow-up-circle" class="w-7 h-7"></i>${item.upvotes}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">Seekers</p>
                                    <p class="text-3xl font-bold text-indigo-600 flex items-center gap-2"><i data-lucide="users" class="w-7 h-7"></i><span id="seeker-count">${item.seekers}</span></p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 flex items-center space-x-4">
                            ${fundsVerifiedBadge}
                            <span class="text-sm font-semibold">${daysRemainingHtml}</span>
                        </div>
                        
                        ${finderModuleHtml}

                        <div class="mt-6 grid grid-cols-1 gap-4">
                             ${actionButtons}
                             <button data-id="${item.id}" id="join-hunt-btn-detail" class="w-full ${joinButtonClasses} font-semibold py-3 rounded-lg hover:bg-indigo-200 transition-colors flex items-center justify-center space-x-2">
                                ${joinButtonText}
                             </button>
                             <button data-item-name="${item.name}" id="get-ai-insights-btn" class="w-full bg-white border-2 border-indigo-500 text-indigo-600 font-semibold py-3 rounded-lg hover:bg-indigo-50 transition-colors flex items-center justify-center space-x-2">
                                <i data-lucide="sparkles" class="w-5 h-5"></i><span>Get AI Market Insights</span>
                             </button>
                        </div>
                    </div>
                </div>

                <!-- Simulated Comments Section -->
                <div class="mt-12">
                    <h3 class="text-xl font-bold mb-4">Community Discussion (${item.comments})</h3>
                    <div class="space-y-6">
                        <div class="flex items-start space-x-3">
                            <img src="https://i.pravatar.cc/40?u=commenter1" class="w-10 h-10 rounded-full"/>
                            <div class="bg-white p-3 rounded-lg border border-gray-200 comment-bubble">
                                <p class="text-sm font-semibold">@vintageVixen</p>
                                <p class="text-gray-700">Absolute grail piece. I've been looking for one in this condition for ages. Upvoted!</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            detailView.classList.add('active');
            lucide.createIcons();

            if (item.fundsVerified) {
                simulateFinderAssignment(item);
            }

            document.getElementById('back-to-feed').addEventListener('click', () => {
                detailView.classList.remove('active');
                switchView('main-content')
            });
            document.getElementById('delete-iso-btn').addEventListener('click', handleDeleteIso);
            document.getElementById('edit-iso-btn').addEventListener('click', handleEditIso);
            document.getElementById('get-ai-insights-btn').addEventListener('click', handleGetAiInsights);
            document.getElementById('join-hunt-btn-detail').addEventListener('click', handleJoinHunt);
            
            const sellBtn = document.querySelector('.sell-item-btn');
            if (sellBtn) sellBtn.addEventListener('click', handleSellItemClick);

            const viewBidsBtn = document.getElementById('view-bids-btn');
            if (viewBidsBtn) viewBidsBtn.addEventListener('click', handleViewBids);
        }
        
        // =================================================================================
        // NEW DASHBOARD RENDER FUNCTIONS
        // =================================================================================
        
        function renderMyIsoView() {
            const actionContainer = document.getElementById('my-iso-action-required');
            const activeContainer = document.getElementById('my-iso-active-hunts');
            const collectionContainer = document.getElementById('my-iso-collection');

            // Find hunts that the user has "created" or joined.
            const myHunts = isoData.filter(hunt => hunt.joined);
            
            const actionHunt = myHunts.find(h => h.id === 6 && h.privateBids > 0);

            if (actionHunt) {
                actionContainer.innerHTML = `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-300">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-gray-100 rounded-lg bg-cover bg-center" style="background-image: url('${actionHunt.imageUrl}')"></div>
                            <div class="flex-1">
                                <p class="font-bold text-gray-900">${actionHunt.name}</p>
                                <p class="text-sm text-gray-600"><span class="font-semibold text-green-600">${actionHunt.privateBids} New Option</span> from your Finder is ready for review.</p>
                            </div>
                            <button class="view-details-btn bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg" data-id="${actionHunt.id}">Review Now</button>
                        </div>
                    </div>`;
            } else {
                 actionContainer.innerHTML = `<div class="text-center py-6 bg-white rounded-lg border border-gray-200"><p class="text-sm text-gray-500">No actions required right now.</p></div>`;
            }

            if (myHunts.length > 0) {
                activeContainer.innerHTML = myHunts.map(item => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex items-center space-x-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg bg-cover bg-center" style="background-image: url('${item.imageUrl}')"></div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">Status: ${item.finder ? 'Finder Assigned' : (item.fundsVerified ? 'Syndicating' : 'Pending Verification')}</p>
                        </div>
                        <div class="text-right">
                             <p class="text-sm font-semibold text-gray-800">$${item.topOffer.toLocaleString()}</p>
                             <p class="text-xs text-gray-500">Top Offer</p>
                        </div>
                        <div class="flex items-center space-x-4">
                             <button class="remove-hunt-btn text-xs text-red-500 hover:underline font-semibold" data-id="${item.id}">Leave</button>
                             <button class="view-details-btn text-indigo-600 font-semibold" data-id="${item.id}">View</button>
                        </div>
                    </div>
                `).join('');
            } else {
                activeContainer.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-xl border border-gray-200">
                        <i data-lucide="search" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <h3 class="mt-4 text-lg font-semibold text-gray-800">You haven't started or joined any hunts yet.</h3>
                        <p class="mt-1 text-sm text-gray-500">Let's find what you're searching for.</p>
                        <button id="my-iso-create-btn" class="mt-4 bg-indigo-600 text-white font-semibold px-5 py-2 rounded-lg">Create Your First ISO</button>
                    </div>`;
            }
            
            // For demo purposes, we will always show one collection item.
            const collectionItem = isoData.find(i => i.acquired);
            if(collectionItem) {
                const buybackHtml = collectionItem.acquired.hasBuyback 
                ? ` <div class="absolute top-2 right-2">
                        <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full">Buyback Guarantee</span>
                    </div>
                    <div class="absolute bottom-2 left-2 right-2">
                        <button class="initiate-buyback-btn w-full bg-white text-blue-700 text-xs font-bold py-1 rounded-md border border-blue-200 hover:bg-blue-50" data-id="${collectionItem.id}">Initiate Buyback</button>
                    </div>`
                : '';

                collectionContainer.innerHTML = `
                    <div class="relative bg-white p-3 rounded-xl shadow-sm border border-gray-200">
                        <div class="h-40 bg-gray-100 rounded-lg bg-cover bg-center" style="background-image: url('${collectionItem.imageUrl}')"></div>
                        <p class="text-sm font-semibold mt-2 truncate">${collectionItem.name}</p>
                        <p class="text-xs text-gray-500">Acquired for $${collectionItem.acquired.price.toLocaleString()}</p>
                        ${buybackHtml}
                    </div>`;
            } else {
                 collectionContainer.innerHTML = `<p class="text-sm text-gray-500 col-span-full text-center">Your collection will appear here after your first successful hunt.</p>`;
            }

            lucide.createIcons();
        }

        function renderFinderHubView() {
            const huntPoolContainer = document.getElementById('finder-hunt-pool');
            const activeHuntsContainer = document.getElementById('finder-active-hunts');
            
            // Empty states for demo
            const hasPoolItems = true;
            const hasActiveHunts = true;
            
            if(hasPoolItems) {
                 // Simulate a claimed state for the demo
                const isClaimed = finderHubView.dataset.claimed === 'true';
                const buttonText = isClaimed ? 'Unclaim' : 'Claim Hunt';
                const buttonClasses = isClaimed ? 'bg-gray-200 text-gray-500' : 'bg-indigo-600 text-white';

                huntPoolContainer.innerHTML = `
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <p class="text-xs text-gray-500">Sneakers | Posted 2 hours ago</p>
                        <p class="font-bold text-gray-900 mt-1">Travis Scott Jordan 1 Low</p>
                        <div class="flex justify-between items-center mt-2">
                            <div>
                                <p class="text-sm font-semibold text-green-600">$720</p>
                                <p class="text-xs text-gray-500">Buyer's Offer</p>
                            </div>
                            <button class="claim-hunt-btn ${buttonClasses} font-semibold px-4 py-2 rounded-lg">${buttonText}</button>
                        </div>
                    </div>`;
            } else {
                huntPoolContainer.innerHTML = `<div class="text-center py-6 bg-white rounded-lg border border-gray-200"><p class="text-sm text-gray-500">No new hunts in the pool right now.</p></div>`;
            }

            if(hasActiveHunts) {
                activeHuntsContainer.innerHTML = `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <p class="text-xs text-gray-500">Archival Fashion | Claimed 1 day ago</p>
                        <p class="font-bold text-gray-900 mt-1">Raf Simons 'Riot' Bomber Jacket</p>
                        <div class="flex justify-between items-center mt-2">
                             <p class="text-sm text-green-600 font-semibold">1 Option Presented to Buyer</p>
                            <button class="manage-hunt-btn bg-white border border-gray-300 font-semibold px-4 py-2 rounded-lg" data-id="6">Manage</button>
                        </div>
                    </div>`;
            } else {
                 activeHuntsContainer.innerHTML = `<div class="text-center py-6 bg-white rounded-lg border border-gray-200"><p class="text-sm text-gray-500">You have no active hunts.</p></div>`;
            }
        }

        function renderSellerPortalView() {
            const requestsContainer = document.getElementById('seller-requests');
            const offersContainer = document.getElementById('seller-offers');
            
            const hasRequests = true;
            const hasOffers = true;
            
            if(hasRequests){
                 requestsContainer.innerHTML = `
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center space-x-3 mb-3">
                             <img src="https://i.pravatar.cc/40?u=curator" class="w-10 h-10 rounded-full"/>
                             <div>
                                 <p class="text-sm">Request from <span class="font-bold">@TheCurator</span></p>
                                 <p class="text-xs text-gray-500">Archival Fashion Expert</p>
                             </div>
                        </div>
                        <p class="font-bold text-gray-900">Item: Raf Simons 'Riot' Bomber Jacket</p>
                        <p class="text-sm text-gray-600 mt-1">Details: Buyer has verified funds for a $4,500 offer. Do you have this in inventory?</p>
                        <div class="mt-4">
                             <button class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg">Submit Private Offer</button>
                        </div>
                    </div>`;
            } else {
                 requestsContainer.innerHTML = `<div class="text-center py-6 bg-white rounded-lg border border-gray-200"><p class="text-sm text-gray-500">No new requests from Finders.</p></div>`;
            }

            if(hasOffers) {
                 offersContainer.innerHTML = `
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-900">Raf Simons 'Riot' Bomber Jacket</p>
                                <p class="text-sm text-gray-500">Your Offer: $4,400</p>
                            </div>
                            <p class="text-sm font-semibold text-green-600">Presented to Buyer</p>
                        </div>
                    </div>`;
            } else {
                offersContainer.innerHTML = `<div class="text-center py-6 bg-white rounded-lg border border-gray-200"><p class="text-sm text-gray-500">You have not sent any offers.</p></div>`;
            }
        }

        // =================================================================================
        // MODAL & FORM HANDLING FUNCTIONS
        // =================================================================================
        
        /**
         * Switches between the main application views.
         */
        function switchView(viewId, options = {}) {
            document.querySelectorAll('.main-content, .detail-view, .how-it-works-view, .my-iso-view, .finder-hub-view, .seller-portal-view, .landing-view').forEach(view => {
                view.classList.remove('active');
            });
            const targetView = document.getElementById(viewId);
            if(targetView) targetView.classList.add('active');
            window.scrollTo(0, 0);

            document.querySelectorAll('.nav-link, .nav-link-mobile').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.view === viewId) {
                    link.classList.add('active');
                }
            });
             if(['how-it-works-view', 'my-iso-view', 'finder-hub-view', 'seller-portal-view', 'landing-view'].includes(viewId)){
                 lucide.createIcons();
            }

            if (viewId === 'main-content' && options.category) {
                const filterBtn = filterBar.querySelector(`[data-category="${options.category}"]`);
                if (filterBtn) {
                    filterBtn.click();
                }
            }

            // Reset landing page animations when switching to it
            if (viewId === 'landing-view') {
                document.querySelectorAll('.animate-on-scroll').forEach(el => {
                    el.classList.remove('is-visible');
                });
            }
        }
        
        /**
         * Toggles modal visibility.
         */
        function toggleModal(modal, show) { if (show) { modalBackdrop.style.display = 'block'; modal.style.display = 'block'; modal.classList.add('animate-fade-in'); } else { modal.classList.remove('animate-fade-in'); modal.style.display = 'none'; modalBackdrop.style.display = 'none'; } }
        
        /**
         * Resets the manual form.
         */
        function resetIsoForm() {
            isoForm.reset();
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            imageUploadIcon.style.display = 'block';
        }

        /**
         * Handles manual form submission.
         */
        function handleIsoSubmit(e) { 
            e.preventDefault(); 
            const imageUrl = imagePreview.src && imagePreview.src.startsWith('data:') ? imagePreview.src : "https://placehold.co/700x500/e2e8f0/4a5568?text=New+Request";
            const newItem = { 
                id: Date.now(), 
                seekers: 1,
                joined: true, // Creator auto-joins their hunt
                name: document.getElementById('item-name').value, 
                category: document.getElementById('item-category').value, 
                details: document.getElementById('item-details').value, 
                upvotes: 1, 
                topOffer: parseInt(document.getElementById('item-bid').value) || 0, 
                comments: 0, 
                imageUrl: imageUrl,
                user: { name: "@newSeeker", avatar: `https://i.pravatar.cc/40?u=${Date.now()}`, rating: 5.0 },
                fundsVerified: false,
                privateBids: 0,
                duration: parseInt(document.getElementById('item-duration-form').value),
                createdAt: Date.now(),
                finder: null
            }; 
            isoData.unshift(newItem);
            resetIsoForm();
            toggleModal(isoModal, false); 
            switchView('main-content');
        }

        /**
         * Fetches and displays AI insights.
         */
        async function handleGetAiInsights(event) {
            const itemName = event.currentTarget.dataset.itemName;
            toggleModal(aiModal, true);
            aiModalContent.innerHTML = `<div class="flex flex-col items-center justify-center h-48"><div class="loader"></div><p class="mt-4 text-gray-600 font-semibold">Contacting Gemini for insights...</p></div>`;
            
            const systemPrompt = "You are a world-class collectibles expert. Provide a concise, single-paragraph summary of the requested item's history, cultural significance, and general market standing. Speak with authority and insight.";
            const insights = await callGeminiAPI(itemName, systemPrompt);
            
            aiModalContent.innerHTML = `
                <div class="space-y-4">
                    <p class="text-gray-700 leading-relaxed">${insights}</p>
                    <p class="text-xs text-gray-400 pt-2 border-t border-gray-200">✨ Powered by Gemini. Insights are for informational purposes only.</p>
                </div>
                <div class="mt-6 pt-4 border-t">
                     <label for="ai-question" class="block text-sm font-medium text-gray-700 mb-2">Ask a follow-up question</label>
                     <div class="flex space-x-2">
                        <input type="text" id="ai-question-input" class="flex-1 w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="e.g., How does this compare to...?">
                        <button id="ai-ask-btn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg">Ask</button>
                     </div>
                     <div id="ai-answer" class="mt-4 text-sm"></div>
                </div>
            `;
            document.getElementById('ai-ask-btn').addEventListener('click', async () => {
                const questionInput = document.getElementById('ai-question-input');
                const question = questionInput.value;
                if (!question) return;

                const answerDiv = document.getElementById('ai-answer');
                answerDiv.innerHTML = `<div class="flex items-center space-x-2 text-gray-500"><div class="loader !w-4 !h-4 !border-2"></div><span>Getting answer...</span></div>`;

                const followUpPrompt = `In the context of the ${itemName}, the user asks: "${question}". Provide a concise, expert answer.`;
                const answer = await callGeminiAPI(followUpPrompt);
                answerDiv.innerHTML = `<p class="bg-gray-100 p-3 rounded-md">${answer}</p>`;
            });
        }
        
        /**
         * Opens the sell/make offer modal.
         */
        function handleSellItemClick(event) {
            const itemId = event.currentTarget.dataset.itemId;
            const item = isoData.find(i => i.id === parseInt(itemId));
            if (!item) return;
            sellModal.innerHTML = `
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-xl font-bold">Make a Private Offer</h3>
                    <button id="close-sell-modal" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-4">You are making a private offer for the <span class="font-bold">${item.name}</span>. The assigned Finder will verify your item and present it to the buyer.</p>
                    <form id="offer-form" class="space-y-4">
                        <div>
                            <label for="offer-price" class="block text-sm font-medium text-gray-700">Your Offer Price ($)</label>
                            <input type="number" id="offer-price" placeholder="e.g., ${item.topOffer}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="offer-condition" class="block text-sm font-medium text-gray-700">Condition & Details</label>
                            <textarea id="offer-condition" placeholder="e.g., Deadstock, with original box and receipt." required rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div class="pt-4 flex justify-end">
                            <button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Send Private Offer to Finder</button>
                        </div>
                    </form>
                </div>`;
            toggleModal(sellModal, true);
            lucide.createIcons();
            document.getElementById('close-sell-modal').addEventListener('click', () => toggleModal(sellModal, false));
            document.getElementById('offer-form').addEventListener('submit', (e) => {
                e.preventDefault();
                alert(`Your private offer for "${item.name}" has been sent to the Finder for verification!`);
                toggleModal(sellModal, false);
            });
        }

        /**
         * Opens the modal to view private bids.
         */
        function handleViewBids(event) {
            const itemId = parseInt(event.currentTarget.dataset.itemId);
            const item = isoData.find(i => i.id === itemId);
            if (!item || !item.finder) return;

            const bids = privateBidsData[itemId] || [];

            const bidsHtml = bids.map(bid => {
                return `
                <div class="p-4 border rounded-lg bg-white">
                    <div class="flex items-start space-x-4">
                        <img src="${bid.avatar}" class="w-10 h-10 rounded-full mt-1"/>
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-2">
                                    <button class="font-semibold text-gray-800 hover:underline user-profile-link" data-username="${bid.user}">${bid.user}</button>
                                    <span class="text-xs text-gray-500 flex items-center"><i data-lucide="star" class="w-3 h-3 fill-yellow-400 text-yellow-400 mr-1"></i> ${bid.rating}</span>
                                </div>
                                <p class="text-2xl font-bold text-green-600">$${bid.price.toLocaleString()}</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${bid.condition}</p>
                        </div>
                    </div>
                     ${bid.findersNote ? `
                        <div class="mt-3 pt-3 border-t border-gray-200">
                           <div class="flex items-start space-x-3">
                               <img src="${item.finder.avatar}" class="w-8 h-8 rounded-full"/>
                               <div>
                                    <p class="text-xs font-semibold text-indigo-700">Finder's Verification Note:</p>
                                    <p class="text-xs text-gray-600 italic">"${bid.findersNote}"</p>
                               </div>
                           </div>
                        </div>
                    ` : ''}
                    <div class="mt-4 flex space-x-2">
                        <button data-price="${bid.price}" class="accept-offer-btn flex-1 bg-indigo-600 text-white text-sm font-semibold px-4 py-2 rounded-md hover:bg-indigo-700">Accept Offer</button>
                        <button class="flex-1 bg-white border border-gray-300 text-gray-700 text-sm font-semibold px-4 py-2 rounded-md hover:bg-gray-100">Counter-offer</button>
                    </div>
                </div>
            `}).join('');

            bidsModal.innerHTML = `
                 <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold">Options Presented by Your Finder</h3>
                        <p class="text-sm text-gray-500">for ${item.name}</p>
                    </div>
                    <button id="close-bids-modal" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div id="bids-content" class="p-6 bg-gray-50 max-h-[60vh] overflow-y-auto">
                    <div class="space-y-4">${bidsHtml}</div>
                </div>
            `;
            toggleModal(bidsModal, true);
            lucide.createIcons();
            document.getElementById('close-bids-modal').addEventListener('click', () => toggleModal(bidsModal, false));
            document.querySelectorAll('.accept-offer-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleAcceptOffer(item, e.currentTarget.dataset.price));
            });
        }
        
        /**
         * Simulates accepting an offer and shows the celebration/next steps.
         */
        function handleAcceptOffer(item, price) {
            toggleModal(bidsModal, false);
            
            celebrationOverlay.innerHTML = `
                <div class="text-center text-white">
                    <h2 class="text-4xl font-bold">Congratulations!</h2>
                    <p class="text-xl mt-2">The ${item.name} is yours.</p>
                </div>
            `;
            celebrationOverlay.style.display = 'flex';

            setTimeout(() => {
                celebrationOverlay.style.display = 'none';
                showNextStepsModal(item, price);
            }, 2500);
        }

        function showNextStepsModal(item, price) {
            nextStepsModal.innerHTML = `
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold">What Happens Next?</h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-6">Your purchase is confirmed. Here's a summary of the next steps to get your item securely.</p>
                    <div class="space-y-4">
                        <div class="timeline-item relative pl-8 pb-4">
                            <div class="absolute left-0 top-0 flex items-center justify-center bg-green-500 rounded-full w-6 h-6 text-white">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </div>
                            <h4 class="font-semibold">Payment Secured</h4>
                            <p class="text-sm text-gray-500">Your payment of $${(parseInt(price) + (price*0.07) + (price * 0.10) + 15).toLocaleString()} is held securely in escrow.</p>
                        </div>
                         <div class="timeline-item relative pl-8 pb-4">
                            <div class="absolute left-0 top-0 flex items-center justify-center bg-gray-300 rounded-full w-6 h-6">
                               <i data-lucide="ship" class="w-4 h-4 text-gray-600"></i>
                            </div>
                            <h4 class="font-semibold text-gray-500">Seller Ships to Finder</h4>
                            <p class="text-sm text-gray-500">The seller will now ship the item to your expert Finder for verification.</p>
                        </div>
                        <div class="timeline-item relative pl-8 pb-4">
                            <div class="absolute left-0 top-0 flex items-center justify-center bg-gray-300 rounded-full w-6 h-6">
                                <i data-lucide="shield-check" class="w-4 h-4 text-gray-600"></i>
                            </div>
                            <h4 class="font-semibold text-gray-500">Item Verification</h4>
                            <p class="text-sm text-gray-500">Your Finder will verify the item's authenticity and condition and send you a digital report.</p>
                        </div>
                        <div class="relative pl-8">
                             <div class="absolute left-0 top-0 flex items-center justify-center bg-gray-300 rounded-full w-6 h-6">
                               <i data-lucide="package-check" class="w-4 h-4 text-gray-600"></i>
                            </div>
                            <h4 class="font-semibold text-gray-500">Final Delivery</h4>
                            <p class="text-sm text-gray-500">After your approval, the Finder will ship the item directly to you.</p>
                        </div>
                    </div>
                    <div class="pt-6 mt-6 border-t">
                        <button id="close-next-steps" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg">View My ISO Hub</button>
                    </div>
                </div>
            `;
            toggleModal(nextStepsModal, true);
            lucide.createIcons();
            document.getElementById('close-next-steps').addEventListener('click', () => {
                toggleModal(nextStepsModal, false);
                switchView('my-iso-view');
            });
        }
        
        /**
         * Opens the edit modal for an ISO.
         */
        function handleEditIso(event) {
            const itemId = parseInt(event.currentTarget.dataset.id);
            const item = isoData.find(i => i.id === itemId);
            if (!item) return;

            editModal.innerHTML = `
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-xl font-bold">Edit Your Hunt</h3>
                    <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <form id="edit-form" class="p-6 space-y-4">
                     <div><label for="edit-item-name" class="block text-sm font-medium text-gray-700">Item Name</label><input type="text" id="edit-item-name" value="${item.name}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                     <div><label for="edit-item-details" class="block text-sm font-medium text-gray-700">Details</label><input type="text" id="edit-item-details" value="${item.details}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                     <div><label for="edit-item-bid" class="block text-sm font-medium text-gray-700">Your Top Offer ($)</label><input type="number" id="edit-item-bid" value="${item.topOffer}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                     <div><label for="edit-item-duration" class="block text-sm font-medium text-gray-700">Hunt Duration</label>
                        <select id="edit-item-duration" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            <option value="7" ${item.duration === 7 ? 'selected' : ''}>7 Days</option>
                            <option value="14" ${item.duration === 14 ? 'selected' : ''}>14 Days</option>
                            <option value="30" ${item.duration === 30 ? 'selected' : ''}>30 Days</option>
                        </select>
                     </div>
                    <div class="pt-2 flex justify-end"><button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg">Save Changes</button></div>
                </form>
            `;
            toggleModal(editModal, true);
            lucide.createIcons();

            document.getElementById('close-edit-modal').addEventListener('click', () => toggleModal(editModal, false));
            document.getElementById('edit-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const itemIndex = isoData.findIndex(i => i.id === itemId);
                if (itemIndex > -1) {
                    isoData[itemIndex].name = document.getElementById('edit-item-name').value;
                    isoData[itemIndex].details = document.getElementById('edit-item-details').value;
                    isoData[itemIndex].topOffer = parseInt(document.getElementById('edit-item-bid').value);
                    isoData[itemIndex].duration = parseInt(document.getElementById('edit-item-duration').value);
                    renderDetailView(itemId); // Re-render the detail view to show changes
                    renderFeed(filterBar.querySelector('.active').dataset.category, searchBar.value);
                }
                toggleModal(editModal, false);
            });
        }
        
        /**
         * Renders the profile modal for a user.
         */
        function renderProfileModal(username) {
            // In a real app, you'd fetch this data. Here we'll find a user from our mock data.
            const user = Object.values(isoData).map(d => d.user).find(u => u.name === username) || 
                         Object.values(privateBidsData).flat().map(b => b.user).find(u => u.name === username) ||
                         Object.values(isoData).map(d => d.finder).find(f => f && f.name === username) ||
                         { name: username, avatar: 'https://i.pravatar.cc/80', rating: 4.5, specialty: 'Collector' };
            
            const isFinder = user.name === '@TheCurator'; // Demo logic

            profileModal.innerHTML = `
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-xl font-bold">User Profile</h3>
                    <button id="close-profile-modal" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-6">
                    <div class="flex items-center space-x-4">
                        <img src="${user.avatar}" class="w-20 h-20 rounded-full"/>
                        <div>
                            <h4 class="text-lg font-bold">${user.name}</h4>
                            <p class="text-sm text-indigo-600 font-semibold">${isFinder ? 'Vetted Finder' : 'Collector'}</p>
                            <div class="flex items-center mt-1">
                                <i data-lucide="star" class="w-4 h-4 fill-yellow-400 text-yellow-400 mr-1"></i>
                                <span class="font-bold">${user.rating || 5.0}</span>
                                <span class="text-sm text-gray-500 ml-1">(23 reviews)</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h5 class="font-semibold mb-2">Recent Activity</h5>
                        <div class="space-y-3">
                            <div class="text-sm text-gray-600"><span class="font-semibold text-green-600">SUCCESS:</span> Found a Rolex Daytona for @watchguy.</div>
                            <div class="text-sm text-gray-600"><span class="font-semibold text-blue-600">ACTIVE:</span> Sourcing a Raf Simons Bomber for @archive_fiend.</div>
                        </div>
                    </div>
                </div>
            `;
            toggleModal(profileModal, true);
            lucide.createIcons();
            document.getElementById('close-profile-modal').addEventListener('click', () => toggleModal(profileModal, false));
        }

        // =================================================================================
        // NEW CHAT & FINDER LOGIC
        // =================================================================================
        let currentChatStep = 0;
        let isoInProgress = {};
        const chatFlow = [
            { bot: "Hey! I'll help create your ISO. What are you searching for?", key: 'name', placeholder: "e.g., Jordan 1 'Chicago'" },
            { bot: "Got it. Any specific details? (Size, condition, etc.)", key: 'details', placeholder: "e.g., Size 10, New" },
            { bot: "Great. Now, let's craft a compelling description to attract the best Finders and Sellers.", action: 'generate_description' },
            { bot: "Which category does this fall under?", action: 'category' },
            { bot: "What's the top offer you'd like to make for this item?", key: 'topOffer', placeholder: "$550" },
            { bot: "A picture is worth a thousand words! Please upload a reference image for your hunt.", action: 'image' },
            { bot: "How long should this hunt be active for?", action: 'duration' },
            { bot: "Great. To ensure sellers know you're serious, we'll simulate a fund verification. This signals you're a ready buyer.", action: 'verify' },
            { bot: "Perfect! Your funds are verified. We are now matching your ISO with a vetted expert Finder.", action: 'syndicate' }
        ];

        function startChat() {
            currentChatStep = 0;
            isoInProgress = {};
            chatLog.innerHTML = '';
            addBotMessage(chatFlow[0].bot);
            chatInput.placeholder = chatFlow[0].placeholder;
            chatInput.disabled = false;
            chatSubmit.disabled = false;
            chatInput.focus();
        }

        function addMessage(content, isUser = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `chat-message flex ${isUser ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble p-3 rounded-2xl text-sm ${isUser ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}`;
            bubble.innerHTML = content;
            messageWrapper.appendChild(bubble);
            chatLog.appendChild(messageWrapper);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        
        function addBotMessage(text) {
            addMessage(text, false);
        }

        function addUserMessage(text) {
            addMessage(text, true);
        }

        function handleChatSubmission() {
            const userText = chatInput.value.trim();
            if (!userText) return;

            addUserMessage(userText);
            const currentStep = chatFlow[currentChatStep];
            if (currentStep.key) {
                isoInProgress[currentStep.key] = userText;
            }

            chatInput.value = '';
            chatInput.disabled = true;
            chatSubmit.disabled = true;

            currentChatStep++;
            processNextChatStep();
        }
        
        function processNextChatStep() {
            const nextStep = chatFlow[currentChatStep];
            if (!nextStep) {
                chatInput.placeholder = "All done!";
                return;
            }
            
            const typingIndicator = `<div class="chat-message flex justify-start"><div class="chat-bubble p-3 rounded-2xl bg-gray-200"><div class="typing-indicator flex items-center space-x-1"><span></span><span></span><span></span></div></div></div>`;
            chatLog.innerHTML += typingIndicator;
            chatLog.scrollTop = chatLog.scrollHeight;

            setTimeout(async () => {
                chatLog.removeChild(chatLog.lastChild);
                addBotMessage(nextStep.bot);
                
                if (nextStep.action === 'generate_description') {
                    const generateBtnHTML = `
                        <button id="generate-desc-btn" class="mt-2 w-full flex items-center justify-center space-x-2 bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            <span>Generate Description with AI</span>
                        </button>`;
                    addMessage(generateBtnHTML, false);
                    lucide.createIcons();
                    document.getElementById('generate-desc-btn').addEventListener('click', async (e) => {
                        e.target.closest('button').innerHTML = `<div class="loader !w-5 !h-5 !border-2"></div>`;
                        const prompt = `Generate a compelling, one-sentence marketplace description for an ISO (In Search Of) post. The item is a "${isoInProgress.name}" with these details: "${isoInProgress.details}".`;
                        const generatedDesc = await callGeminiAPI(prompt);
                        isoInProgress.details = generatedDesc; // Overwrite details with AI version
                        addUserMessage(`<em>Used AI to generate a new description: "${generatedDesc}"</em>`);
                        currentChatStep++;
                        processNextChatStep();
                    });
                } else if (nextStep.action === 'category') {
                     const categories = ['Sneakers', 'Archival Fashion', 'Collectibles', 'Watches'];
                     const categoryButtonsHTML = `
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${categories.map(cat => `<button class="chat-action-btn bg-white border border-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-full hover:bg-gray-100">${cat}</button>`).join('')}
                        </div>
                     `;
                     addMessage(categoryButtonsHTML, false);
                     document.querySelectorAll('.chat-action-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const category = btn.textContent;
                            isoInProgress.category = category;
                            addUserMessage(category);
                            currentChatStep++;
                            processNextChatStep();
                        });
                     });
                } else if (nextStep.action === 'duration') {
                    const durations = [7, 14, 30];
                    const durationButtonsHTML = `
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${durations.map(dur => `<button class="chat-action-btn bg-white border border-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-full hover:bg-gray-100" data-duration="${dur}">${dur} Days</button>`).join('')}
                        </div>
                    `;
                    addMessage(durationButtonsHTML, false);
                    document.querySelectorAll('.chat-action-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const duration = btn.dataset.duration;
                            isoInProgress.duration = parseInt(duration);
                            addUserMessage(`${duration} Days`);
                            currentChatStep++;
                            processNextChatStep();
                        });
                    });
                } else if (nextStep.action === 'image') {
                    const imageUploaderHTML = `
                        <div class="mt-2 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <img id="chat-image-preview" src="" class="hidden mx-auto h-24 w-auto mb-4 rounded-md"/>
                                <svg id="chat-image-upload-icon" class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-600">
                                    <label for="chat-image-upload-input" class="relative cursor-pointer bg-gray-200 rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500 px-1">
                                        <span>Upload a file</span>
                                        <input id="chat-image-upload-input" name="file-upload" type="file" class="sr-only" accept="image/*">
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                            </div>
                        </div>`;
                    addMessage(imageUploaderHTML, false);
                    document.getElementById('chat-image-upload-input').addEventListener('change', handleChatImageUpload);
                } else if (nextStep.action === 'verify') {
                    setTimeout(() => {
                        const successMsg = `<div class="flex items-center space-x-2"><i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i><p>Funds Verified!</p></div>`;
                        addMessage(successMsg, false);
                        lucide.createIcons();
                        currentChatStep++;
                        processNextChatStep();
                    }, 2000);
                } else if (nextStep.action === 'syndicate') {
                    setTimeout(() => {
                        createNewIsoFromChat();
                        toggleModal(isoModal, false);
                    }, 2000);
                } else {
                    chatInput.placeholder = nextStep.placeholder;
                    chatInput.disabled = false;
                    chatSubmit.disabled = false;
                    chatInput.focus();
                }
            }, 1500);
        }
        
        function createNewIsoFromChat() {
            const newItem = {
                id: Date.now(),
                seekers: 1,
                joined: true, // Creator auto-joins their hunt
                name: isoInProgress.name,
                details: isoInProgress.details,
                topOffer: parseInt(isoInProgress.topOffer.replace(/\D/g,'')) || 0,
                category: isoInProgress.category || "Uncategorized",
                upvotes: 1,
                comments: 0,
                imageUrl: isoInProgress.imageUrl || "https://placehold.co/700x500/e2e8f0/4a5568?text=New+Hunt",
                user: { name: "@newSeeker", avatar: `https://i.pravatar.cc/40?u=${Date.now()}`, rating: 5.0 },
                fundsVerified: true,
                privateBids: 0,
                duration: isoInProgress.duration || 30,
                createdAt: Date.now(),
                finder: null
            };
            isoData.unshift(newItem);
            switchView('main-content');
        }

        function handleChatImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                isoInProgress.imageUrl = event.target.result;
                const preview = document.getElementById('chat-image-preview');
                const icon = document.getElementById('chat-image-upload-icon');
                if (preview) {
                    preview.src = event.target.result;
                    preview.classList.remove('hidden');
                }
                if (icon) icon.style.display = 'none';

                addUserMessage('<em>Image successfully uploaded.</em>');
                currentChatStep++;
                processNextChatStep();
            };
            reader.readAsDataURL(file);
        }

        function simulateFinderAssignment(item) {
            const finderModule = document.getElementById('finder-module');
            if (!finderModule) return;

            // Initial status: searching for a finder
            finderModule.innerHTML = `
                <h3 class="text-lg font-bold text-gray-900 mb-1">Hunt Status</h3>
                <div class="p-4 bg-gray-50 border rounded-lg flex items-center space-x-3">
                    <div class="loader !w-5 !h-5 !border-2"></div>
                    <p class="text-sm font-medium text-gray-700">Matching your hunt with a vetted expert Finder...</p>
                </div>
            `;
            finderModule.classList.remove('opacity-0');

            // Simulate a delay for finding and assigning a Finder
            setTimeout(() => {
                if (item.finder) {
                    showNotification(`Expert Finder '${item.finder.name}' has claimed the hunt for the ${item.name}.`, 'They will now source and verify options for you.');
                    
                    finderModule.innerHTML = `
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">Your Hunt Manager</h3>
                        <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-lg">
                            <div class="flex items-center space-x-4">
                                <img src="${item.finder.avatar}" class="w-12 h-12 rounded-full"/>
                                <div class="flex-1">
                                    <button class="font-bold text-gray-900 dark:text-white hover:underline user-profile-link" data-username="${item.finder.name}">${item.finder.name}</button>
                                    <p class="text-sm text-indigo-700 dark:text-indigo-400 font-medium">${item.finder.specialty}</p>
                                </div>
                                <span class="text-sm text-gray-500 dark:text-gray-400 flex items-center"><i data-lucide="star" class="w-4 h-4 fill-yellow-400 text-yellow-400 mr-1"></i> ${item.finder.rating}</span>
                            </div>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-3 italic">
                                "'${item.finder.name}' is now sourcing items from our private seller network. You'll be notified as soon as verified options are ready to review."
                            </p>
                        </div>
                    `;
                    lucide.createIcons();
                } else {
                     finderModule.innerHTML = `
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">Hunt Status</h3>
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 border dark:border-gray-700 rounded-lg flex items-center space-x-3">
                            <i data-lucide="send" class="w-5 h-5 text-gray-700"></i>
                            <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Syndicating your hunt directly to the seller network.</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }, 3000); // 3-second delay for simulation
        }

        function handleDeleteIso(event) {
            const itemId = parseInt(event.currentTarget.dataset.id);
            if (confirm('Are you sure you want to delete this hunt? This action cannot be undone.')) {
                const itemIndex = isoData.findIndex(item => item.id === itemId);
                if (itemIndex > -1) {
                    isoData.splice(itemIndex, 1);
                    switchView('main-content');
                    renderFeed();
                }
            }
        }
        
        function handleJoinHunt(event) {
            const itemId = parseInt(event.currentTarget.dataset.id);
            const item = isoData.find(i => i.id === itemId);
            if (!item) return;

            item.joined = !item.joined;

            if (item.joined) {
                item.seekers++;
                showNotification('You have joined the hunt!', 'You will be notified of all private offers for this item.');
            } else {
                item.seekers--;
                showNotification('You have left the hunt.', 'You will no longer receive private offers.');
            }

            if (detailView.classList.contains('active')) {
                const detailButton = document.getElementById('join-hunt-btn-detail');
                 if (detailButton && parseInt(detailButton.dataset.id) === itemId) {
                    renderDetailView(itemId);
                }
            }
            
            renderMyIsoView(); // Re-render the dashboard to reflect the change
        }
        
        function showNotification(title, message, icon='check-circle', color='green') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = 'bg-white rounded-xl shadow-lg p-4 border border-gray-200 notification-enter-animation';
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i data-lucide="${icon}" class="h-6 w-6 text-${color}-500"></i>
                    </div>
                    <div class="ml-3 w-0 flex-1 pt-0.5">
                        <p class="text-sm font-medium text-gray-900">${title}</p>
                        <p class="mt-1 text-sm text-gray-500">${message}</p>
                    </div>
                </div>
            `;
            container.appendChild(notification);
            lucide.createIcons();

            setTimeout(() => {
                notification.style.transition = 'opacity 0.5s ease';
                notification.style.opacity = '0';
                setTimeout(() => container.removeChild(notification), 500);
            }, 5000);
        }

        function renderMessagesModal() {
            messagesModal.innerHTML = `
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-xl font-bold">Messages</h3>
                    <button id="close-messages-modal" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div class="flex items-start space-x-3 p-3 bg-indigo-50 rounded-lg cursor-pointer">
                            <img src="https://i.pravatar.cc/40?u=curator" class="w-10 h-10 rounded-full"/>
                            <div>
                                <p class="font-bold">@TheCurator</p>
                                <p class="text-sm text-gray-600">I've found a great option for the Raf Simons jacket...</p>
                            </div>
                        </div>
                         <div class="flex items-start space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                            <img src="https://i.pravatar.cc/40?u=user1" class="w-10 h-10 rounded-full"/>
                            <div>
                                <p class="font-bold">@grailHunter</p>
                                <p class="text-sm text-gray-500">Can you find me the Olive colorway?</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            toggleModal(messagesModal, true);
            lucide.createIcons();
            document.getElementById('close-messages-modal').addEventListener('click', () => toggleModal(messagesModal, false));
        }

        function renderLandingPage() {
            const categories = [
                { name: "Sneakers", img: "https://images.unsplash.com/photo-1552346154-21d32810aba3?auto=format&fit=crop&q=80&w=800", count: "1.2k" },
                { name: "Archival Fashion", img: "images/tobias-tullius-Fg15LdqpWrs-unsplash.jpg", count: "850" },
                { name: "Watches", img: "https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3?auto=format&fit=crop&q=80&w=800", count: "420" },
                { name: "Collectibles", img: "https://images.unsplash.com/photo-1608346128025-1896b97a6fa7?auto=format&fit=crop&q=80&w=800", count: "310" }
            ];

            const container = document.getElementById('landing-categories');
            container.innerHTML = categories.map((cat, index) => `
                <div data-category="${cat.name}" class="landing-category-card group cursor-pointer relative overflow-hidden rounded-xl aspect-[4/5]">
                    <img src="${cat.img}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                    <div class="absolute bottom-0 left-0 p-6 text-white">
                        <h3 class="text-2xl font-bold">${cat.name}</h3>
                        <div class="h-0.5 w-12 bg-white/50 mt-2 group-hover:w-full transition-all duration-500"></div>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.landing-category-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const category = e.currentTarget.dataset.category;
                    switchView('main-content', { category: category });
                });
            });

            // Animated Counter
            const counterElement = document.getElementById('post-counter');
            const targetCount = 1337; // A more impressive number for demo
            
            const animateCounter = (el, target) => {
                let current = 0;
                const step = Math.max(1, Math.ceil(target / 100));
                const interval = setInterval(() => {
                    current += step;
                    if (current >= target) {
                        clearInterval(interval);
                        if (target > 9999) {
                            el.textContent = '9999+';
                        } else {
                            el.textContent = target.toLocaleString();
                        }
                    } else {
                        el.textContent = current.toLocaleString();
                    }
                }, 20);
            };
            animateCounter(counterElement, targetCount);

            // Scroll Animations
            const scrollElements = document.querySelectorAll('.animate-on-scroll');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    } else {
                        // Optional: remove class when it scrolls out of view to re-trigger on scroll up
                        // entry.target.classList.remove('is-visible');
                    }
                });
            }, { threshold: 0.1 });

            scrollElements.forEach(el => {
                observer.observe(el);
            });
        }

        // =================================================================================
        // INITIALIZATION & EVENT LISTENERS
        // =================================================================================
        function initializeApp() {
            lucide.createIcons();
            
            // Initial render
            renderFeed();
            renderMyIsoView();
            renderFinderHubView();
            renderSellerPortalView();
            renderLandingPage();
            switchView('landing-view'); // Start on the landing page

            // Event Listeners
            const openCreateModal = () => {
                toggleModal(isoModal, true);
                resetIsoForm();
                startChat(); // Start the chat by default
                chatView.style.display = 'block';
                formView.style.display = 'none';
                tabChat.classList.add('text-indigo-600', 'border-indigo-500');
                tabForm.classList.remove('text-indigo-600', 'border-indigo-500');
            };

            postIsoBtn.addEventListener('click', openCreateModal);
            closeIsoModalBtn.addEventListener('click', () => toggleModal(isoModal, false));
            isoForm.addEventListener('submit', handleIsoSubmit);
            
            // Chat vs Form tabs
            tabChat.addEventListener('click', () => {
                chatView.style.display = 'block';
                formView.style.display = 'none';
                tabChat.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-500');
                tabForm.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-500');
                startChat();
            });
            tabForm.addEventListener('click', () => {
                chatView.style.display = 'none';
                formView.style.display = 'block';
                tabForm.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-500');
                tabChat.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-500');
            });
            
            // Chat submission
            chatSubmit.addEventListener('click', handleChatSubmission);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !chatSubmit.disabled) {
                    handleChatSubmission();
                }
            });

            // Image upload preview
            imageUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.src = event.target.result;
                        imagePreview.classList.remove('hidden');
                        imageUploadIcon.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Search and filter
            searchBar.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                const activeFilter = filterBar.querySelector('.active').dataset.category;
                renderFeed(activeFilter, searchTerm);
            });

            filterBar.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    filterBar.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                        btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                    });
                    e.target.classList.add('active', 'bg-indigo-600', 'text-white');
                    e.target.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                    renderFeed(e.target.dataset.category, searchBar.value);
                }
            });
            
            // View switching
            document.querySelectorAll('.nav-link, .nav-link-mobile, #logo-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = e.currentTarget.dataset.view || 'landing-view';
                    switchView(viewId);
                });
            });
            
            document.querySelectorAll('.profile-dropdown-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(e.currentTarget.dataset.view);
                    profileDropdown.classList.add('hidden');
                });
            });

            // Dynamic event listeners for cards, etc.
            app.addEventListener('click', (e) => {
                const viewDetailsBtn = e.target.closest('.view-details-btn, .manage-hunt-btn');
                if (viewDetailsBtn) {
                    renderDetailView(viewDetailsBtn.dataset.id);
                }
                
                const initiateBuybackBtn = e.target.closest('.initiate-buyback-btn');
                if (initiateBuybackBtn) {
                    handleInitiateBuyback(initiateBuybackBtn);
                }
                
                const myIsoCreateBtn = e.target.closest('#my-iso-create-btn');
                if (myIsoCreateBtn) {
                    postIsoBtn.click();
                }

                const claimHuntBtn = e.target.closest('.claim-hunt-btn');
                if (claimHuntBtn) {
                    const isClaimed = finderHubView.dataset.claimed === 'true';
                    finderHubView.dataset.claimed = !isClaimed;
                    renderFinderHubView();
                }
                
                const removeHuntBtn = e.target.closest('.remove-hunt-btn');
                if (removeHuntBtn) {
                    handleJoinHunt(removeHuntBtn); // Same logic as joining/leaving
                }
            });
            
            // Modal closing
            document.getElementById('close-ai-modal').addEventListener('click', () => toggleModal(aiModal, false));
            messagesBtn.addEventListener('click', renderMessagesModal);
            
            // Landing page buttons
            document.getElementById('landing-post-hunt-btn').addEventListener('click', openCreateModal);
            document.getElementById('landing-become-finder-btn').addEventListener('click', () => switchView('main-content'));
            document.getElementById('landing-view-all-btn').addEventListener('click', () => switchView('main-content'));

            // Profile Dropdown Logic
            profileDropdownBtn.addEventListener('click', () => {
                profileDropdown.classList.toggle('hidden');
            });

            // Close dropdown if clicking outside
            window.addEventListener('click', (e) => {
                if (!profileDropdownBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.add('hidden');
                }
            });
        }
    })();
    </script>
</body>
</html>